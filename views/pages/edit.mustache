{{> header }}

<div class="container-fluid p-4">

  <div class="mt-2 mb-2">
    <a href="/dashboard?view=help" class="btn btn-secondary"> ‚Üê Back to Help Files</a>
  </div>

  <h2 class="mb-4">Edit Help File</h2>

  <form id="editForm" method="POST" action="/helpfiles/{{document_id}}/edit">
    
    {{#errors}}
      <div class="alert alert-danger">{{msg}}</div>
    {{/errors}}
    {{#success}}
      <div class="alert alert-success">{{success}}</div>
    {{/success}}

    <div class="form-group">
      <label>Document ID</label>
      <input name="document_id" class="form-control" value="{{document_id}}" readonly>
    </div>

    <div class="form-group">
      <label>Title</label>
      <input name="title" class="form-control" value="{{titleValue}}">
    </div>

    <div class="form-group">
      <label>Category (comma separated)</label>
      <input name="categories" class="form-control" value="{{category}}">
    </div>

    <div class="form-group">
      <label>Tags (comma separated)</label>
      <input name="tags" class="form-control" value="{{tags}}" placeholder="e.g. labels, actions">
    </div>

    {{#isAdmin}}
      <div class="form-group">
        <label>References (JSON)</label>
        <textarea name="references" class="form-control" rows="6">{{references}}</textarea>
        <small class="form-text text-muted">
          Must be valid JSON. Use <a href="https://jsonlint.com" target="_blank">jsonlint.com</a> if unsure.
        </small>
      </div>
    {{/isAdmin}}

    {{^isAdmin}}
      <div class="form-group">
        <label>References (View Only)</label>
        <pre class="form-control bg-light" style="overflow:auto; min-height: 150px;">{{references}}</pre>
        <small class="form-text text-muted">Only Admins can edit references.</small>
      </div>
    {{/isAdmin}}

    <p class="bold mt-4">Content Sections (View Only)</p>
    {{#content_sections}}
      <div class="card mb-3">
        <div class="card-header">
          <strong>{{section_title}}</strong>
        </div>
        <div class="card-body overflow-auto">
          <pre class="mb-0" style="white-space: pre-wrap;">{{text}}</pre>
        </div>
      </div>
    {{/content_sections}}

    <div class="mt-4">
      <button type="submit" class="btn btn-success">Update Help File</button>
      <a href="/preview/{{document_id}}" class="btn btn-secondary ml-2">Preview File</a>
    </div>
  </form>

  {{#changelogs.length}}
    <hr />
    <h5 class="mb-3 mt-4">Recent Changes</h5>
    <ul class="list-group mb-4">
      {{#changelogs}}
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong class="text-capitalize text-primary">{{action}}</strong>
              by <span class="text-success">{{user.name}}</span>
            </div>
            <small class="text-muted">{{timestamp}}</small>
          </div>
          {{#differences.length}}
            <ul class="mt-2 mb-0 ps-3">
              {{#differences}}
                <li><i class="fas fa-circle fa-2xs text-info"></i> {{.}}</li>
              {{/differences}}
            </ul>
          {{/differences.length}}
        </li>
      {{/changelogs}}
    </ul>
  {{/changelogs.length}}

  {{^changelogs.length}}
    <div class="alert alert-info text-center mt-4">No recent changes logged.</div>
  {{/changelogs.length}}
</div>

<script>
  document.getElementById("editForm").addEventListener("submit", function(e) {
    const confirmEdit = confirm("Are you sure you want to update this help file?");
    if (!confirmEdit) e.preventDefault();
  });
</script>